{% extends "base.html" %}
{% block title %}View Exam - {{ exam.title }}{% endblock %}

{% block extra_css %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/view_exam.css') }}">

{% endblock %}

{% block content %}
<div class="container">

    <!-- Header -->
    <div class="exam-header">
        <h1 class="exam-title">
            <i class="bi bi-file-earmark-text"></i> {{ exam.title }}
        </h1>
        <p class="exam-description">
            {{ exam.description or "No description provided." }}
        </p>
        <div class="header-actions">
            <a href="{{ url_for('exam_analytics', exam_id=exam.id) }}" class="btn btn-secondary">
                 Analytics
            </a>
        </div>
    </div>

    <!-- Exam Controls Panel -->
    <div class="card exam-controls-panel">
        <div class="card-header">
            <h3 class="card-title">
                <i class="bi bi-sliders"></i> Exam Controls
            </h3>
        </div>
        
        <div class="card-body">
            <div class="control-buttons">
                <!-- Force End Exam Button -->
                <form method="POST" action="{{ url_for('faculty_force_end_exam', exam_id=exam.id) }}" 
                      onsubmit="return confirm('⚠️ Are you sure you want to END this exam for ALL students?\n\nThis will:\n✓ Auto-submit all active exams\n✓ Calculate final scores\n✓ Block new attempts\n\nThis action cannot be undone!');">
                    <button type="submit" 
                            class="btn btn-danger"
                            {% if exam.status == 'ended' or exam.force_ended %}disabled{% endif %}>
                        <i class="bi bi-stop-circle"></i>
                        {% if exam.status == 'ended' or exam.force_ended %}
                            Exam Ended
                        {% else %}
                            Force End Exam
                        {% endif %}
                    </button>
                </form>

                <!-- Extend Time Button -->
                {% if exam.status != 'ended' and not exam.force_ended %}
                <button onclick="showExtendTimeModal()" class="btn btn-extend">
                    <i class="bi bi-clock-history"></i> Extend Time
                </button>
                {% endif %}

                <!-- Refresh Status Button -->
                <button onclick="location.reload()" class="btn btn-refresh">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Status
                </button>
            </div>

            <!-- Exam Status Display -->
            <div class="status-display {% if exam.status == 'ended' or exam.force_ended %}status-ended{% else %}status-active{% endif %}">
                <i class="bi bi-{% if exam.status == 'ended' or exam.force_ended %}x-circle-fill{% else %}check-circle-fill{% endif %}"></i>
                <span>
                    Status: 
                    {% if exam.force_ended %}
                        Force Ended by Faculty
                    {% elif exam.status == 'ended' %}
                        Ended
                    {% else %}
                        Active
                    {% endif %}
                </span>
            </div>
        </div>
    </div>

    <!-- Live Student Status -->
    <div class="card live-status-panel">
        <div class="card-header">
            <h3 class="card-title">
                <i class="bi bi-graph-up"></i> Live Student Status
            </h3>
        </div>
        
        {% set active_count = student_exams|selectattr('submitted_at', 'none')|list|length if student_exams else 0 %}
        {% set completed_count = student_exams|rejectattr('submitted_at', 'none')|list|length if student_exams else 0 %}
        
        <div class="card-body">
            <div class="stats-grid">
                <div class="stat-card stat-active">
                    <div class="stat-value">{{ active_count }}</div>
                    <div class="stat-label">
                        <i class="bi bi-pencil-square"></i> Taking Exam
                    </div>
                </div>
                
                <div class="stat-card stat-completed">
                    <div class="stat-value">{{ completed_count }}</div>
                    <div class="stat-label">
                        <i class="bi bi-check-circle"></i> Completed
                    </div>
                </div>
                
                <div class="stat-card stat-duration">
                    <div class="stat-value">{{ exam.duration or exam.duration_minutes or 60 }}</div>
                    <div class="stat-label">
                        <i class="bi bi-clock"></i> Minutes Duration
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exam Details Drawer -->
    <details class="drawer">
        <summary class="drawer-toggle">
            <i class="bi bi-info-circle"></i> Exam Details
        </summary>
        <div class="drawer-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Overview</h3>
                </div>
                <div class="card-body">
                    <table class="info-table">
                        <tbody>
                            <tr>
                                <td class="info-label">Duration</td>
                                <td class="info-value">{{ exam.duration_minutes or exam.duration or 60 }} minutes</td>
                            </tr>
                            <tr>
                                <td class="info-label">Passing Score</td>
                                <td class="info-value">{{ exam.passing_score or 40 }}%</td>
                            </tr>
                            <tr>
                                <td class="info-label">Status</td>
                                <td>
                                    {% if exam.is_active %}
                                        <span class="badge badge-success">Active</span>
                                    {% else %}
                                        <span class="badge badge-danger">Inactive</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="info-label">Start Time</td>
                                <td class="info-value">{{ exam.start_time or "Not set" }}</td>
                            </tr>
                            <tr>
                                <td class="info-label">End Time</td>
                                <td class="info-value">{{ exam.end_time or "Not set" }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </details>

    <!-- Access Control Drawer -->
    <details class="drawer">
        <summary class="drawer-toggle">
            <i class="bi bi-shield-lock"></i> Exam Access Control
        </summary>
        <div class="drawer-content">
            <div class="card">
                <div class="card-header space-between">
                    <h3 class="card-title">Exam Access Control</h3>
                    <div id="access-status-badge">
                        {% if exam.is_active %}
                            {% if exam.allow_all_students %}
                                <span class="badge badge-success">Open to All</span>
                            {% else %}
                                <span class="badge badge-warning">Restricted Access</span>
                            {% endif %}
                        {% else %}
                            <span class="badge badge-danger">Access Stopped</span>
                        {% endif %}
                    </div>
                </div>

                <div class="card-body">
                    <form method="POST" action="{{ url_for('update_exam_access', exam_id=exam.id) }}" id="access-form">

                        <label class="form-label">Who can access this exam?</label>

                        <!-- Stop Access -->
                        <div class="access-option access-stopped">
                            <label class="access-option-label">
                                <input type="radio" name="access_mode" value="stopped"
                                       id="radio-stopped"
                                       {% if not exam.is_active %}checked{% endif %}>
                                <div>
                                    <strong><i class="bi bi-stop-circle"></i> Stop Exam Access</strong>
                                    <p>Disable the exam — No student can attempt it.</p>
                                </div>
                            </label>
                        </div>

                        <!-- Allow All -->
                        <div class="access-option access-all">
                            <label class="access-option-label">
                                <input type="radio" name="access_mode" value="all"
                                       id="radio-all"
                                       {% if exam.is_active and exam.allow_all_students %}checked{% endif %}>
                                <div>
                                    <strong><i class="bi bi-people"></i> Allow All Students</strong>
                                    <p>Any registered student can attempt this exam.</p>
                                </div>
                            </label>
                        </div>

                        <!-- Specific -->
                        <div class="access-option access-specific">
                            <label class="access-option-label">
                                <input type="radio" name="access_mode" value="specific"
                                       id="radio-specific"
                                       {% if exam.is_active and not exam.allow_all_students %}checked{% endif %}>
                                <div>
                                    <strong><i class="bi bi-person-check"></i> Allow Specific Students Only</strong>
                                    <p>Choose students individually or by batch.</p>
                                </div>
                            </label>

                            <button type="button" id="select-students-btn"
                                    class="btn btn-primary btn-select"
                                    {% if not(exam.is_active and not exam.allow_all_students) %}disabled{% endif %}>
                                <i class="bi bi-person-plus"></i> Select Students
                            </button>
                        </div>

                        <input type="hidden" name="allowed_students"
                               id="allowed-students-input"
                               value="{{ exam.allowed_students or '' }}">

                        <div id="selected-students-display" class="selected-students-box">
                            <strong>Selected Students: <span id="selected-count">0</span></strong>
                            <div id="selected-students-list" class="students-list"></div>
                        </div>
<br>
                        <button type="submit" class="btn btn-extend ">
                            <i class="bi bi-check-circle"></i> Save Access Settings
                        </button>

                    </form>
                </div>
            </div>
        </div>
    </details>

    <!-- Questions Drawer -->
    <details class="drawer">
        <summary class="drawer-toggle">
            <i class="bi bi-question-circle"></i> Questions ({{ exam.questions|length }})
        </summary>
        <div class="drawer-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Questions</h3>
                </div>
                <div class="card-body">
                    {% if exam.questions %}
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Question</th>
                                    <th>Marks</th>
                                    <th>Correct Answer</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for q in exam.questions %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ q.question_text }}</td>
                                    <td>{{ q.points or 1 }}</td>
                                    <td>{{ q.correct_answer }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-center empty">No questions added yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </details>

</div>

<!-- Extend Time Modal -->
<div id="extendTimeModal" class="custom-modal">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h3><i class="bi bi-clock-history"></i> Extend Exam Time</h3>
            <button class="modal-close" onclick="hideExtendTimeModal()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        
        <form method="POST" action="{{ url_for('faculty_extend_exam_time', exam_id=exam.id) }}">
            <div class="modal-body">
                <label class="form-label">Additional Minutes:</label>
                <input type="number" name="extra_minutes" min="1" max="120" value="15" required class="form-input">
            </div>
            
            <div class="modal-footer">
                <button type="button" onclick="hideExtendTimeModal()" class="btn btn-outline">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Extend Time
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Student Selection Modal -->
<div id="student-selection-modal" class="custom-modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3><i class="bi bi-people"></i> Select Students for Exam Access</h3>
            <button class="modal-close" id="modal-close-btn">
                <i class="bi bi-x"></i>
            </button>
        </div>

        <div class="modal-body">
            
            <!-- Range Selection Section -->
            <div class="range-selection-section">
    <h4><i class="bi bi-list-ol"></i> Quick Range Selection by Roll ID</h4>
    <p class="help-text">
        <strong>Select students by their Roll ID.</strong><br>
        Examples: 
        <code>1-20</code> (selects roll ID 1 to 20), 
        <code>21-40</code> (selects roll ID 21 to 40), 
        <code>1-20, 21-40</code> (selects both ranges)
    </p>
    
    <div class="range-input-group">
        <input type="text" 
               id="range-input" 
               class="form-input" 
               placeholder="e.g., 1-20, 21-40 or 1,5,10,15-20">
        <button type="button" id="apply-range-btn" class="btn btn-primary">
            <i class="bi bi-check2-square"></i> Apply Range
        </button>
        <button type="button" id="clear-range-btn" class="btn btn-outline">
            <i class="bi bi-x-square"></i> Clear
        </button>
    </div>
    
    <div id="range-error" class="range-error"></div>
</div>

            <div class="divider"></div>

            <!-- Batch Filter -->
            <div class="filter-section">
                <label class="form-label"><i class="bi bi-funnel"></i> Filter by Batch:</label>
                <div class="batch-filter-group">
                    <select id="batch-filter" class="form-input">
                        <option value="">All Batches</option>
                        {% for batch in all_batches %}
                            <option value="{{ batch }}">{{ batch }}</option>
                        {% endfor %}
                    </select>
                    <button id="select-batch-btn" class="btn btn-primary">
                        <i class="bi btn-primary"></i> Select Batch
                    </button>
                    <button id="deselect-batch-btn" class="btn btn-outline btn-sm">
                        <i class="bi bi-x"></i> Deselect Batch
                    </button>
                </div>
            </div>

            <!-- Search -->
            <div class="search-section">
                <label class="form-label"><i class="bi bi-search"></i> Search Students:</label>
                <input id="student-search" 
                       class="form-input" 
                       placeholder="Search by name or PRN..." 
                       type="text">
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button id="select-all-btn" class="btn btn-success">
                    <i class="bi bi-check-all"></i> Select All
                </button>
                <button id="deselect-all-btn" class="btn btn-danger">
                    <i class="bi bi-x"></i> Deselect All
                </button>
                <div class="selection-counter">
                    Selected: <span id="modal-selected-count">0</span>
                </div>
            </div>

            <!-- Student Grid -->
            <!-- Student Grid -->
<div class="students-grid">
    <div id="student-list">
        {% if all_students %}
            {% for s in all_students %}
            <label class="student-item"
                   data-student-id="{{ s.id }}"
                   data-batch="{{ s.batch or '' }}"
                   data-roll-id="{{ s.roll_id or '' }}"
                   data-position="{{ loop.index }}">
                <input type="checkbox" 
                       class="student-checkbox"
                       value="{{ s.id }}"
                       {% if exam.allowed_students and (s.id|string) in exam.allowed_students.split(',') %}checked{% endif %}>
                <div class="student-info">
                    <div class="student-number">#{{ loop.index }}</div>
                    <strong class="student-name">{{ s.full_name }}</strong>
                    <div class="student-meta">
                        <span>Roll ID: {{ s.roll_id or 'N/A' }}</span>
                        {% if s.batch %}
                        <span>• {{ s.batch }}</span>
                        {% endif %}
                        {% if s.prn_number %}
                        <span>• PRN: {{ s.prn_number }}</span>
                        {% endif %}
                    </div>
                </div>
            </label>
            {% endfor %}
        {% else %}
            <p class="empty-state">No students found.</p>
        {% endif %}
    </div>
</div>

        </div>

        <div class="modal-footer">
            <button id="modal-cancel-btn" class="btn btn-outline btn-lg">
                Cancel
            </button>
            <button id="modal-save-btn" class="btn btn-primary btn-lg">
                <i class="bi bi-save"></i> Save Selection
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/view_exam.js') }}"></script>
{% endblock %}